<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Panel</title>
</head>
<style>
    body {
        color: white;
        background-color: black;
        background-image: url('images/bg/bg.jpg');
        /* background-image: url('bg.jpg'); */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        margin: 0;
        height: 100vh;
        /* Ensure the body takes up the full height of the viewport */
        overflow: hidden;
        /* Optional: Prevent scrolling if the background image doesn't cover the content */
    }

    /* Media query for screens smaller than 480px */
    @media (max-width: 600px) {
        .image-container {
            /* background-color: rgba(255, 255, 255, 0.397); */
            margin: auto;
            padding: 10px;
            display: grid !important;
            gap: 10px;
            max-width: fit-content;
            grid-template-columns: 1fr 1fr 1fr;
        }

        .image-wrapper,
        .upload-container {
            max-width: 120px;
            /* 3 images per row */
            max-height: 120px;
            margin: auto;
        }
    }

    @media (max-width: 400px) {

        /* for very small screens */
        .image-wrapper,
        .upload-container {
            max-width: 110px;
            max-height: 110px;
            margin: auto;
        }
    }


    .panel {
        position: fixed;
        bottom: -80%;
        left: 0;
        width: 100%;
        height: 80%;
        background-color: #1111117d;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        transition: bottom 0.6s cubic-bezier(0.42, 0, 0, 1.74);
        /* jumping effect */
        border-top: 1px solid black;
        overflow-y: auto;
    }

    /* image container */
    .image-container {
        /* margin: 10px; */
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        /* height: fit-content; */
        max-width: fit-content;
    }

    /* image  */
    .image-wrapper {
        position: relative;
        width: 200px;
        height: 150px;
        margin-right: 0px;
    }

    .image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* box-shadow: 0 0 3px black; */
        border-radius: 5px;
    }

    /* small btn for images */
    /* small btn for images */
    .delete-btn {
        position: absolute;
        border: none;
        color: rgb(255, 255, 255);
        background-color: rgba(0, 0, 0, 0.5);
        /* Add a background color for better visibility */
        cursor: pointer;
        border-radius: 50%;
        /* Ensure the button is circular */
        width: 20px;
        height: 20px;
        display: none;
        align-items: center;
        /* Center text vertically */
        justify-content: center;
        /* Center text horizontally */
        display: none;
        /* Use flexbox */
        line-height: 20px;
        /* Ensure text is vertically centered */
        text-align: center;
        /* Center text horizontally */
        font-size: 14px;
        /* Adjust font size if needed */
        padding: 0;
        /* Remove default padding */
        box-sizing: border-box;
        /* Ensure padding and border are included in the width and height */
    }


    .open-btn:active,
    .delete-btn:active {
        transform: scale(0.9);
    }

    .delete-btn {
        top: -8px;
        right: -10px;
        background-color: rgba(255, 0, 0, 0.7);
    }


    .image-wrapper:hover .delete-btn {
        display: flex;
    }

    /* new image upload */
    .upload-container {
        width: 150px;
        height: 150px;
        /* border: 2px dashed #cccccca9; */
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
    }

    .plus-icon {
        padding: 60px;
        cursor: pointer;
        font-size: 48px;
        color: #999;
    }

    .file-upload {
        display: none;
    }

    .btn {
        font-size: 14px;
        cursor: pointer;
        float: right;
        padding: 6px;
        margin: 1px;
        background-color: #0000007f;
        border: 1px solid;
        /* border-radius: 5px; */
        color: aqua;

        line-height: 7px;
    }

    a {
        text-decoration: none;
    }

    input {
        padding: 0;
        border: 0px;
        background-color: black;
    }

    input::-webkit-input-placeholder {
        color: #ffffff86;
    }

    /* refresh animation */
    .image-wrapper {
        opacity: 0;
        transition: opacity 0.5s ease-in;
    }

    .image-wrapper.loaded {
        opacity: 1;
    }

    .upload-container {
        opacity: 0;
        transition: opacity 0.2s ease-in;
    }

    .upload-container.loaded {
        opacity: 1;
    }

    /* Ê®°ÊÄÅÁ™óÂè£Ê†∑Âºè */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
    }

    .modal-image {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
    }

    .modal-buttons {
        position: absolute;
        bottom: -50px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
    }

    .modal-btn {
        padding: 3px 6px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: 1px solid #666;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .modal-btn:hover {
        background-color: rgba(0, 0, 0, 0.9);
    }

    .modal-btn.success {
        background-color: #4CAF50;
        border-color: #4CAF50;
    }

    .close-modal {
        position: absolute;
        top: -40px;
        right: 0;
        color: white;
        font-size: 30px;
        cursor: pointer;
    }

    .size-info {
        color: #aaa;
        font-size: 12px;
        margin-top: 10px;
        text-align: center;
    }

    .toggle-container {
        float: left;
        display: flex;
        align-items: center;
        margin: 5px;
        font-size: 13px;
        color: #000;
        /* Using black for better visibility */
        font-weight: bold;
        gap: 8px;
    }

    /* iOS Style Switch */
    .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #333;
        transition: .3s;
        border-radius: 20px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: #34c759;
    }

    #quickDelete:checked+.slider {
        background-color: #ff3b30;
    }

    input:focus+.slider {
        box-shadow: 0 0 1px #34c759;
    }

    input:checked+.slider:before {
        transform: translateX(14px);
    }

    /* ÂØÜÁ†ÅÊ®°ÊÄÅÊ°Ü */
    .pwd-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .pwd-content {
        background-color: #222;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #444;
        width: 300px;
        text-align: center;
    }

    .pwd-content input {
        width: 100%;
        padding: 10px;
        margin: 15px 0;
        background: #000;
        border: 1px solid #555;
        color: #fff;
        border-radius: 5px;
        box-sizing: border-box;
    }

    .pwd-btns {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .pwd-btn {
        flex: 1;
        padding: 8px;
        cursor: pointer;
        border-radius: 5px;
        border: none;
    }

    .pwd-ok {
        background: #34c759;
        color: white;
    }

    .pwd-cancel {
        background: #444;
        color: white;
    }

    input:checked+.slider:before {
        transform: translateX(14px);
    }

    /* Áªü‰∏ÄÊ®°ÊÄÅÊ°ÜÂü∫Á°ÄÊ†∑Âºè */
    .generic-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .modal-box {
        background-color: #1e1e1e;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #333;
        width: 320px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .modal-box h3 {
        margin-top: 0;
        color: #fff;
    }

    .modal-box p {
        color: #aaa;
        font-size: 14px;
        line-height: 1.5;
    }

    .modal-box input {
        width: 100%;
        padding: 12px;
        margin: 16px 0;
        background: #000;
        border: 1px solid #444;
        color: #fff;
        border-radius: 6px;
        box-sizing: border-box;
        outline: none;
    }

    .modal-box input:focus {
        border-color: #34c759;
    }

    .modal-btn-group {
        display: flex;
        justify-content: gap;
        gap: 12px;
        margin-top: 10px;
    }

    .m-btn {
        flex: 1;
        padding: 10px;
        cursor: pointer;
        border-radius: 6px;
        border: none;
        font-weight: bold;
        transition: 0.2s;
    }

    .close-x {
        position: absolute;
        top: 8px;
        right: 12px;
        color: #777;
        font-size: 24px;
        cursor: pointer;
        line-height: 1;
    }

    .close-x:hover {
        color: #fff;
    }

    .m-btn-ok {
        background: #34c759;
        color: white;
    }

    .m-btn-ok:hover {
        background: #2eb04f;
    }

    .m-btn-cancel {
        background: #333;
        color: #eee;
    }

    .m-btn-cancel:hover {
        background: #444;
    }

    .m-btn-danger {
        background: #ff3b30;
        color: white;
    }

    .m-btn-danger:hover {
        background: #e0352b;
    }

    /* Toast Ê†∑Âºè */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 3000;
        pointer-events: none;
    }

    .toast {
        background: rgba(52, 199, 89, 0.9);
        color: white;
        padding: 10px 20px;
        border-radius: 50px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 14px;
        font-weight: bold;
        animation: toast-in 0.3s ease-out, toast-out 0.3s ease-in 2s forwards;
    }

    .toast.error {
        background: rgba(255, 59, 48, 0.9);
    }

    @keyframes toast-in {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes toast-out {
        from {
            transform: translateY(0);
            opacity: 1;
        }

        to {
            transform: translateY(-20px);
            opacity: 0;
        }
    }
</style>

<body>
    <!-- Top Right Box Selection Area -->
    <div style="position: fixed; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 1000; align-items: center;">
        <input class="btn" type="text" id="boxname" onkeydown="handleKeyDown(event)" placeholder="Box Name"
            style="float: none; margin: 0; width: 120px; background: rgba(0,0,0,0.7); border: 1px solid #555;">
        <button class="btn" onclick="refreshImageList()"
            style="float: none;margin: 0;/* background-color: #34c759; */color: white;/* border: none; *//* font-weight: bold; */border-radius: 4px;padding: 10px 15px;">Go</button>
    </div>

    <a class="btn" style="color: rgb(255, 255, 255); float: left; border: none;" href='index.html'>
        < Back</a>
            <a class="btn" style="color: rgb(255, 255, 255); float: left; border: none;"
                href='https://squoosh.app'>Squoosh</a>
            <br>
            <br>
            <button id="opencloseBtn" class="btn" onclick="clearbox()"
                style="color: rgb(248, 140, 140);"><b>clear</b></button>
            <button id="reloadimages" class="btn" onclick="refreshImageList()"> <b>reload</b></button>
            <button id="opencloseBtn" class="btn" onclick="openClosePanel()"> <b>images</b></button>
            <button id="permissionBtn" class="btn" onclick="managePermission()"
                style="color: #ffd700;"><b>Permission</b></button>
            <div class="toggle-container" style="display:inline-block; margin-right: 15px;">
                <label class="switch">
                    <input type="checkbox" id="autoCompress" onchange="saveCompressState()">
                    <span class="slider"></span>
                </label>
                <label for="autoCompress" style="color: black; font-weight: bold;">Auto Compress</label>
            </div>
            <div class="toggle-container" style="display:inline-block;">
                <label class="switch">
                    <input type="checkbox" id="quickDelete" onchange="saveQuickDeleteState()">
                    <span class="slider"></span>
                </label>
                <label for="quickDelete" style="color: black; font-weight: bold;">Quick Delete</label>
            </div>
            <div id="panel" class="panel">

                <div id="image-container" class="image-container">
                    <!-- add here -->
                    <div class="upload-container" ondragover="event.preventDefault()"
                        ondragenter="event.preventDefault()" ondrop="handleDrop(event)">
                        <label for="file-upload" class="upload-label">
                            <span class="plus-icon">+</span>
                        </label>
                        <input type="file" id="file-upload" onchange="uploadImagesfromInput()" class="file-upload"
                            multiple>
                    </div>
                </div>
            </div>

            <!-- Áªü‰∏ÄÊùÉÈôêÁÆ°ÁêÜÁ™óÂè£ -->
            <div id="permModal" class="generic-modal">
                <div class="modal-box" style="position: relative;">
                    <span class="close-x" onclick="closePermModal()">&times;</span>
                    <h3>Box Permission</h3>
                    <p id="permStatusDesc" style="margin-bottom: 20px;"></p>

                    <div id="permFields">
                        <div id="oldPwdWrap">
                            <input type="password" id="permOldPwd" placeholder="Current Password">
                        </div>
                        <input type="password" id="permNewPwd" placeholder="New Password">
                        <div class="modal-btn-group">
                            <button class="m-btn m-btn-ok" id="permSubmitBtn">Update</button>
                            <button class="m-btn m-btn-danger" id="permRemoveBtn" style="display:none;"
                                onclick="handleRemoveProtection()">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂØÜÁ†ÅÊ®°ÊÄÅÁ™óÂè£ (‰ªÖÁî®‰∫éÊìç‰ΩúÊó∂ÁöÑÂç≥Êó∂Ê†°È™å) -->
            <div id="pwdModal" class="generic-modal">
                <div class="modal-box" style="position: relative;">
                    <span class="close-x" onclick="closePwdModal()">&times;</span>
                    <h3 id="pwdTitle">Password Required</h3>
                    <p id="pwdDesc"></p>
                    <input type="password" id="pwdInput" placeholder="Enter password...">
                    <div class="modal-btn-group">
                        <button class="m-btn m-btn-ok" id="pwdSubmit" style="width: 100%;">Confirm</button>
                    </div>
                </div>
            </div>

            <!-- Á°ÆËÆ§Ê®°ÊÄÅÁ™óÂè£ -->
            <div id="confirmModal" class="generic-modal">
                <div class="modal-box">
                    <h3 id="confirmTitle">Are you sure?</h3>
                    <p id="confirmDesc"></p>
                    <div class="modal-btn-group">
                        <button class="m-btn m-btn-cancel" id="confirmCancel">Cancel</button>
                        <button class="m-btn m-btn-ok" id="confirmOk">OK</button>
                    </div>
                </div>
            </div>

            <!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÁ™óÂè£ -->
            <div id="imageModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <img id="modalImage" class="modal-image">
                    <div id="imageSize" class="size-info"></div>
                    <div class="modal-buttons">
                        <button class="modal-btn" onclick="copyImageUrl()">Â§çÂà∂ÈìæÊé•</button>
                        <button class="modal-btn" onclick="deleteCurrentImage()">Âà†Èô§ÂõæÁâá</button>
                    </div>
                </div>
            </div>

            <div id="toast-container"></div>
</body>

</html>

<script>//Âü∫Á°Ä


    function showImage(url) {
        // This will be handled by the specialized showImage function below
    }

    var isPanelOpened = false
    function openClosePanel() {
        if (!isPanelOpened) {
            document.getElementById('panel').style.bottom = '0';
        } else {
            document.getElementById('panel').style.bottom = '-80%';
        }
        isPanelOpened = !isPanelOpened
    }
    // dragdrop
    function handleDrop(event) {
        event.preventDefault();
        var file = event.dataTransfer.files[0];
        if (file) {
            showToast("File dropped: " + file.name);
        }
    }

    function loadEmojiIcon(curEmoji) {
        //Â∞ÜÁΩëÈ°µÂõæÊ†áÊîπÊàêemoji curEmoji
        const favicon = document.querySelector('link[rel="icon"]');
        // favicon.href = `https://www.emojiall.com/en/header-svg/${curEmoji}.svg`;
        favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${curEmoji}</text></svg>`;
    }
</script>

<script>
    var imagenamelist = [];
    // ‰∏ä‰º† ‰∏ãËΩΩ reload Âà†Èô§Áõ∏ÂÖ≥Êìç‰Ωú 
    function getboxname() {
        var boxnameElement = document.getElementById('boxname');
        if (boxnameElement.value === "") {
            console.log('Boxname element not found,using 1 as default');
            return '1';
        } else {
            // console.log('Boxname:', boxnameElement.value);
            localStorage.setItem('image-box-name', boxnameElement.value);
            return boxnameElement.value;
        }
    }
    function refreshImageList() {
        var boxname = getboxname();

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/getImageList/' + boxname);

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);
                // console.log(data);
                imagenamelist = data;
                // Clear the existing images
                var imageContainer = document.getElementById('image-container');
                imageContainer.innerHTML = '';

                if (data.length === 0) {
                    console.log('No images found');
                }
                else {
                    // Loop through the data and create image elements
                    data.forEach(function (image) {
                        var imageWrapper = document.createElement('div');
                        imageWrapper.className = 'image-wrapper';
                        imageWrapper.id = image;

                        var img = document.createElement('img');
                        img.src = 'images/' + boxname + '/' + image;
                        img.alt = image; // 
                        img.className = 'image';
                        img.onclick = function () { showImage(image); }; // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂

                        var deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.onclick = function () { deleteImageByUrl(image); };
                        deleteBtn.innerHTML = '&times;';

                        imageWrapper.appendChild(img);
                        imageWrapper.appendChild(deleteBtn);

                        imageContainer.appendChild(imageWrapper);

                        // Add a delay to ensure the element is fully added to the DOM before starting the animation
                        setTimeout(function () {
                            imageWrapper.classList.add('loaded');
                        }, 10);
                    });

                }

                // Add upload container at the end
                var uploadContainer = document.createElement('div');
                uploadContainer.className = 'upload-container';
                uploadContainer.setAttribute('ondragover', 'event.preventDefault()');
                uploadContainer.setAttribute('ondragenter', 'event.preventDefault()');
                uploadContainer.setAttribute('ondrop', 'handleDrop(event)');

                var uploadLabel = document.createElement('label');
                uploadLabel.className = 'upload-label';
                uploadLabel.setAttribute('for', 'file-upload');
                uploadLabel.innerHTML = '<span class="plus-icon">+</span>';

                var fileUpload = document.createElement('input');
                fileUpload.type = 'file';
                fileUpload.id = 'file-upload';
                fileUpload.className = 'file-upload';
                fileUpload.setAttribute('multiple', '');
                fileUpload.onchange = uploadImagesfromInput;

                uploadContainer.appendChild(uploadLabel);
                uploadContainer.appendChild(fileUpload);
                imageContainer.appendChild(uploadContainer);

                // Add a delay to ensure the element is fully added to the DOM before starting the animation
                setTimeout(function () {
                    uploadContainer.classList.add('loaded');
                }, 10);
            } else if (xhr.readyState === 4) {
                console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', xhr.status);
            }
        };
        xhr.send();
    }

    async function uploadImagesfromInput() {
        var fileInput = document.getElementById('file-upload');
        if (!fileInput || !fileInput.files) {
            console.error('File input or files not found.');
            return;
        }

        const formData = await prepareFormData(Array.from(fileInput.files));

        uploadImages(formData)
            .then(data => {
                console.log(data);
                refreshImageList(); // ‰∏ä‰º†ÂêéÂà∑Êñ∞ÂõæÁâáÂàóË°®
            })
            .catch(error => {
                console.error('ËØ∑Ê±ÇÂá∫Èîô:', error);
            });
    }



    async function deleteImageByUrl(url) {
        const skipConfirm = document.getElementById('quickDelete').checked;
        let confirmed = true;
        if (!skipConfirm) {
            confirmed = await openConfirmModal("Delete Image", "This action cannot be undone. Are you sure?");
        }

        if (confirmed) {
            var boxname = getboxname();
            var filename = url;
            async function tryDelete() {
                var password = getSavedPassword(boxname);
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/deleteImage/' + boxname + '/' + filename, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                if (password) xhr.setRequestHeader('x-box-password', password);

                xhr.onreadystatechange = async function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            showToast("Deleted successfully");
                            var imageWrapper = document.getElementById(url);
                            if (imageWrapper) imageWrapper.remove();
                        } else if (xhr.status === 401) {
                            const newPwd = await openPwdModal("Auth Failed", "Enter correct password for this box:");
                            if (newPwd !== null) {
                                savePassword(boxname, newPwd);
                                tryDelete();
                            }
                        } else {
                            showToast('Error: ' + xhr.responseText, true);
                        }
                    }
                };
                xhr.send();
            }
            tryDelete();
        }
    }

    async function clearbox() {
        const confirmed = await openConfirmModal("Clear Box", "This will delete ALL images in current box. Continue?");
        if (confirmed) {
            var boxname = getboxname();
            async function tryClear() {
                var password = getSavedPassword(boxname);
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/clearBox/' + boxname, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                if (password) xhr.setRequestHeader('x-box-password', password);

                xhr.onreadystatechange = async function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            showToast("Box cleared");
                            setTimeout(() => location.reload(), 1000);
                        } else if (xhr.status === 401) {
                            const newPwd = await openPwdModal("Auth Failed", "Enter correct password for this box:");
                            if (newPwd !== null) {
                                savePassword(boxname, newPwd);
                                tryClear();
                            }
                        } else {
                            showToast('Error: ' + xhr.responseText, true);
                        }
                    }
                };
                xhr.send();
            }
            tryClear();
        }
    }


    // ÁõëÂê¨Á≤òË¥¥‰∫ã‰ª∂
    document.addEventListener('paste', async function (event) {
        var items = (event.clipboardData || event.originalEvent.clipboardData).items;
        var file = null;

        // ÈÅçÂéÜÁ≤òË¥¥Êùø‰∏≠ÁöÑÂÜÖÂÆπ
        for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                file = items[i].getAsFile();
                break;
            }
        }

        if (file !== null) {
            // ÊûÑÂª∫ FormData ÂØπË±°Âπ∂Á°Æ‰øùÊñá‰ª∂ÂêçÂîØ‰∏Ä
            const formData = await prepareFormData([file]);

            // Ëé∑Âèñ boxname
            var boxname = getboxname();

            uploadImages(formData, boxname)
                .then(data => {
                    console.log(data);
                    refreshImageList(); // ÂÅáËÆæÊúâ‰∏Ä‰∏™ÂáΩÊï∞Êù•Âà∑Êñ∞‰∏ä‰º†ÂêéÁöÑÂõæÁâáÂàóË°®
                })
                .catch(error => {
                    console.error('ËØ∑Ê±ÇÂá∫Èîô:', error);
                });
        }
    });

    // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†ÁöÑ‰∏ªÂáΩÊï∞
    async function handleDrop(event) {
        event.preventDefault();
        const files = Array.from(event.dataTransfer.files).slice(0, 10); // ÈôêÂà∂‰∏ä‰º†Êñá‰ª∂Êï∞‰∏∫10
        const formData = await prepareFormData(files);

        uploadImages(formData)
            .then(data => {
                console.log(data);
                refreshImageList(); // ‰∏ä‰º†ÂêéÂà∑Êñ∞ÂõæÁâáÂàóË°®
            })
            .catch(error => {
                console.error('ËØ∑Ê±ÇÂá∫Èîô:', error);
            });
    }

    // ÂáÜÂ§á FormData ÂØπË±°
    async function prepareFormData(files) {
        const formData = new FormData();
        const autoCompress = document.getElementById('autoCompress').checked;

        for (const file of files) {
            let fileToUpload = file;
            if (autoCompress && file.type.startsWith('image/')) {
                try {
                    fileToUpload = await compressImage(file);
                } catch (e) {
                    console.error('Compression failed:', e);
                }
            }

            const uniqueFileName = getUniqueFileName(fileToUpload.name);
            console.log('newFile:', uniqueFileName);

            const newFile = new File([fileToUpload], uniqueFileName, { type: fileToUpload.type });
            formData.append('image', newFile);
            imagenamelist.push(uniqueFileName);
        }

        return formData;
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Max dimensions
                    const MAX_WIDTH = 1920;
                    const MAX_HEIGHT = 1080;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(blob => {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', 0.8); // 0.8 quality
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }


    // Ëé∑ÂèñÂîØ‰∏ÄÁöÑÊñá‰ª∂ÂêçÔºàÈò≤Ê≠¢ÂÜ≤Á™ÅÔºâ
    function getUniqueFileName(originalName) {
        let modifiedName = originalName;
        let counter = 1;

        while (imagenamelist.includes(modifiedName)) {
            const extensionIndex = originalName.lastIndexOf('.');
            if (extensionIndex !== -1) {
                // Êñá‰ª∂ÂêçÂåÖÂê´Êâ©Â±ïÂêçÁöÑÊÉÖÂÜµ
                const nameWithoutExtension = originalName.substring(0, extensionIndex);
                const extension = originalName.substring(extensionIndex);
                modifiedName = `${nameWithoutExtension}-${counter}${extension}`;
            } else {
                // Ê≤°ÊúâÊâ©Â±ïÂêçÁöÑÊÉÖÂÜµ
                modifiedName = `${originalName}-${counter}`;
            }
            counter++;
        }

        return modifiedName;
    }

    // ÊâßË°åÂõæÁâá‰∏ä‰º†ËØ∑Ê±Ç
    async function uploadImages(formData) {
        var boxname = getboxname();
        async function tryUpload() {
            var password = getSavedPassword(boxname);
            const response = await fetch('/api/uploadImage/' + boxname, {
                method: 'POST',
                body: formData,
                headers: password ? { 'x-box-password': password } : {}
            });

            if (response.status === 401) {
                const newPwd = await openPwdModal("Auth Failed", "Enter correct password for this box:");
                if (newPwd !== null) {
                    savePassword(boxname, newPwd);
                    return await tryUpload();
                }
                throw new Error('Unauthorized');
            }
            if (!response.ok) {
                const text = await response.text();
                showToast("Upload failed: " + text, true);
                throw new Error(text || `HTTP ÈîôËØØÔºÅÁä∂ÊÄÅ: ${response.status}`);
            }
            showToast("Upload success!");
            return response.text();
        }
        return await tryUpload();
    }

    // --- ÊùÉÈôêÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞ ---

    function getSavedPassword(boxname) {
        return localStorage.getItem('box-password-' + boxname);
    }

    function savePassword(boxname, pwd) {
        localStorage.setItem('box-password-' + boxname, pwd);
    }

    let pwdResolve = null;
    function openPwdModal(title, desc = "") {
        document.getElementById('pwdTitle').innerText = title;
        document.getElementById('pwdDesc').innerText = desc;
        document.getElementById('pwdInput').value = "";
        document.getElementById('pwdModal').style.display = 'flex';
        document.getElementById('pwdInput').focus();
        return new Promise((resolve) => {
            pwdResolve = resolve;
        });
    }

    function closePwdModal() {
        document.getElementById('pwdModal').style.display = 'none';
        if (pwdResolve) pwdResolve(null);
    }

    function closePermModal() {
        document.getElementById('permModal').style.display = 'none';
    }

    document.getElementById('pwdSubmit').onclick = function () {
        const val = document.getElementById('pwdInput').value;
        document.getElementById('pwdModal').style.display = 'none';
        if (pwdResolve) pwdResolve(val);
    };

    document.getElementById('pwdInput').onkeydown = function (e) {
        if (e.key === 'Enter') document.getElementById('pwdSubmit').click();
    };

    let confirmResolve = null;
    function openConfirmModal(title, desc = "") {
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmDesc').innerText = desc;
        document.getElementById('confirmModal').style.display = 'flex';
        return new Promise((resolve) => {
            confirmResolve = resolve;
        });
    }

    document.getElementById('confirmOk').onclick = function () {
        document.getElementById('confirmModal').style.display = 'none';
        if (confirmResolve) confirmResolve(true);
    };

    document.getElementById('confirmCancel').onclick = function () {
        document.getElementById('confirmModal').style.display = 'none';
        if (confirmResolve) confirmResolve(false);
    };

    function showToast(msg, isError = false) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast' + (isError ? ' error' : '');
        toast.innerText = msg;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
    }


    async function managePermission() {
        const boxname = getboxname();
        const hasPwdRes = await fetch('/api/hasPassword/' + boxname);
        const { hasPassword } = await hasPwdRes.json();

        const statusDesc = document.getElementById('permStatusDesc');
        const oldPwdWrap = document.getElementById('oldPwdWrap');
        const removeBtn = document.getElementById('permRemoveBtn');
        const submitBtn = document.getElementById('permSubmitBtn');
        const newPwdInput = document.getElementById('permNewPwd');
        const oldPwdInput = document.getElementById('permOldPwd');

        const savedPwd = getSavedPassword(boxname);
        oldPwdInput.value = savedPwd || "";
        newPwdInput.value = "";

        if (hasPassword) {
            statusDesc.innerHTML = `<span style="color:#34c759; font-size:18px; font-weight:bold;">Protected</span><br><small style="color:#666">Server file: images/${boxname}/password.txt</small>`;
            oldPwdWrap.style.display = "block";
            removeBtn.style.display = "block";
            submitBtn.innerText = "Update Password";
            newPwdInput.placeholder = "New Password";
        } else {
            statusDesc.innerHTML = `<span style="color:#888; font-size:18px; font-weight:bold;">No Protection</span>`;
            oldPwdWrap.style.display = "none";
            removeBtn.style.display = "none";
            submitBtn.innerText = "Enable Protection";
            newPwdInput.placeholder = "Set Password";
        }

        submitBtn.onclick = async () => {
            const oldPassword = oldPwdInput.value;
            const newPassword = newPwdInput.value;
            if (!hasPassword && !newPassword) {
                showToast("Please enter a password", true);
                return;
            }
            const res = await fetch('/api/setPassword/' + boxname, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldPassword, newPassword })
            });
            if (res.ok) {
                showToast("Success!");
                if (newPassword) savePassword(boxname, newPassword);
                else savePassword(boxname, ""); // Handle removal
                closePermModal();
            } else {
                showToast("Failed: " + await res.text(), true);
            }
        };

        const handleEnter = (e) => {
            if (e.key === 'Enter') submitBtn.click();
        };
        oldPwdInput.onkeydown = handleEnter;
        newPwdInput.onkeydown = handleEnter;

        document.getElementById('permModal').style.display = 'flex';
    }

    async function handleRemoveProtection() {
        const boxname = getboxname();
        const oldPassword = document.getElementById('permOldPwd').value;
        if (!oldPassword) {
            showToast("Enter current password to disable", true);
            return;
        }
        const confirmed = await openConfirmModal("Disable Protection", "Are you sure you want to remove password for this box?");
        if (!confirmed) return;
        const res = await fetch('/api/setPassword/' + boxname, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ oldPassword, newPassword: "" })
        });
        if (res.ok) {
            showToast("Protection Removed");
            savePassword(boxname, "");
            closePermModal();
        } else {
            showToast("Failed: " + await res.text(), true);
        }
    }

    // ÁõëÂê¨ÂõûËΩ¶ÈîÆ(TEXT INPUT )
    function handleKeyDown(event) {
        if (event.key === 'Enter') {  // Check if the Enter key was pressed
            event.preventDefault();  // Prevent the default action (e.g., form submission)
            refreshImageList();         // Call the function you want to execute
        }
    }



    // auto do
    //set boxname from localstorage
    var boxname = localStorage.getItem('image-box-name');
    if (boxname) {
        document.getElementById('boxname').value = boxname;
    }

    // Load and set compress state
    function loadCompressState() {
        const savedState = localStorage.getItem('auto-compress-enabled');
        const compressToggle = document.getElementById('autoCompress');
        if (savedState === null) {
            compressToggle.checked = true; // Default to true if never set
        } else {
            compressToggle.checked = savedState === 'true';
        }
    }

    function saveCompressState() {
        const isEnabled = document.getElementById('autoCompress').checked;
        localStorage.setItem('auto-compress-enabled', isEnabled);
    }

    function loadQuickDeleteState() {
        const savedState = localStorage.getItem('quick-delete-enabled');
        const qdToggle = document.getElementById('quickDelete');
        qdToggle.checked = savedState === 'true';
    }

    function saveQuickDeleteState() {
        const isEnabled = document.getElementById('quickDelete').checked;
        localStorage.setItem('quick-delete-enabled', isEnabled);
    }

    loadCompressState();
    loadQuickDeleteState();
    loadEmojiIcon('üèûÔ∏è')
    refreshImageList()
    //wait .5s
    setTimeout(function () {
        openClosePanel()
    }, 500);

    // Ê∑ªÂä†Ê®°ÊÄÅÁ™óÂè£Áõ∏ÂÖ≥ÂäüËÉΩ
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const closeModal = document.querySelector('.close-modal');
    let currentImageUrl = '';

    // ÂÖ≥Èó≠Ê®°ÊÄÅÁ™óÂè£
    closeModal.onclick = function () {
        modal.style.display = 'none';
    }

    // ÁÇπÂáªÊ®°ÊÄÅÁ™óÂè£Â§ñÈÉ®ÂÖ≥Èó≠
    modal.onclick = function (event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }

    // Â§çÂà∂ÂõæÁâáÈìæÊé•
    function copyImageUrl() {
        const boxname = getboxname();
        const fullUrl = window.location.origin + '/images/' + boxname + '/' + currentImageUrl;
        const copyBtn = document.querySelector('.modal-btn:first-child');

        navigator.clipboard.writeText(fullUrl).then(() => {
            copyBtn.textContent = 'Â∑≤Â§çÂà∂';
            copyBtn.classList.add('success');

            setTimeout(() => {
                copyBtn.textContent = 'Â§çÂà∂ÈìæÊé•';
                copyBtn.classList.remove('success');
            }, 1000);
        }).catch(err => {
            console.error('Â§çÂà∂Â§±Ë¥•:', err);
        });
    }

    // Âà†Èô§ÂΩìÂâçÊòæÁ§∫ÁöÑÂõæÁâá
    function deleteCurrentImage() {
        deleteImageByUrl(currentImageUrl);
        modal.style.display = 'none';
    }

    // ‰øÆÊîπÂõæÁâáÁÇπÂáª‰∫ã‰ª∂
    function showImage(url) {
        currentImageUrl = url;
        const boxname = getboxname();
        const fullPath = 'images/' + boxname + '/' + url;
        modalImg.src = fullPath;

        // Fetch file size
        document.getElementById('imageSize').textContent = 'Loading size...';
        fetch(fullPath, { method: 'HEAD' })
            .then(res => {
                const size = res.headers.get('content-length');
                if (size) {
                    const kb = (size / 1024).toFixed(2);
                    const mb = (size / (1024 * 1024)).toFixed(2);
                    document.getElementById('imageSize').textContent = kb > 1024 ? `${mb} MB` : `${kb} KB`;
                } else {
                    document.getElementById('imageSize').textContent = 'Size unknown';
                }
            })
            .catch(() => {
                document.getElementById('imageSize').textContent = 'Size fetch failed';
            });

        modal.style.display = 'flex';
    }
</script>